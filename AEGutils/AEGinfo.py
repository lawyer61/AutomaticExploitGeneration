#-*- coding:utf-8 -*-

'''
关于输入文件的信息获取，比如ELF信息(Elf info)、保护机制(checksec)等
'''

import idaapi
import idc
import platform
import os 
import subprocess
from AEGexceptions import FatalErrorException

def AEG_GetBits():
	info = idaapi.get_inf_structure()
	if info.is_64bit():
		bits = 64
	elif info.is_32bit():
		bits = 32
	else:
		bits = 16
	return bits

def AEG_GetInputName():
	return idc.GetInputFile() 

def AEG_GetInputFilePath():
	return os.path.dirname(idc.GetInputFilePath())

def AEG_GetSecPolicy():
	cmd = "checksec --file=%s --format=csv" % INFO_INPUT_FILENAME
	if INFO_SYSTEM == 'windows':
		cmd = "wsl -- " + cmd 
	proc = subprocess.Popen(cmd , shell= True , stdout = subprocess.PIPE , stderr = subprocess.PIPE)
	out, err = proc.communicate()
	#print out 
	#print err
	if err.strip() != '':
		#print err
		raise FatalErrorException("Check sec fail. : %s " % (err))
	relpo , canary , NX , pie  =  (2 ,True , True ,True)
	out = out.split(',')
	if "no" in out[0].lower():
		relpo = 0
	elif "partial" in out[0].lower():
		relpo = 1 
	if "no" in out[1].lower():
		canary = False
	if "no" in out[2].lower():
		NX = False 
	if "no" in out[3].lower():
		pie = False
	return relpo , canary , NX , pie

INFO_BITS = AEG_GetBits()
INFO_INPUT_FILENAME = AEG_GetInputName()
INFO_INPUT_FILEPATH = AEG_GetInputFilePath()
INFO_SYSTEM = platform.system().lower()
INFO_SEC_RELPO , INFO_SEC_CANARY , INFO_SEC_NX , INFO_SEC_PIE = AEG_GetSecPolicy()
if __name__ == "__main__":
	print INFO_SEC_RELPO , INFO_SEC_CANARY , INFO_SEC_NX , INFO_SEC_PIE